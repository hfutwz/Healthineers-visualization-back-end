<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.mapper.PatientStatisticsMapper">

    <!-- 获取月度时间热力图数据 - 7x13矩阵（6个时间段+总和行，12个月+总和列） -->
    <select id="getMonthlyTimeHeatmapData" resultType="java.util.Map">
        SELECT 
            time_period,
            month,
            patient_count
        FROM (
            -- 原始时间段数据
            SELECT 
                CASE 
                    WHEN ir.time_period = 0 THEN 'night_0_7'
                    WHEN ir.time_period = 1 THEN 'morning_rush_8_9'
                    WHEN ir.time_period = 2 THEN 'lunch_rush_10_11'
                    WHEN ir.time_period = 3 THEN 'afternoon_12_16'
                    WHEN ir.time_period = 4 THEN 'evening_rush_17_19'
                    WHEN ir.time_period = 5 THEN 'night_20_23'
                    ELSE 'unknown'
                END as time_period,
                MONTH(ir.admission_date) as month,
                COUNT(*) as patient_count
            FROM InjuryRecord ir
            WHERE 1=1
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            AND ir.time_period IS NOT NULL
            GROUP BY 
                CASE 
                    WHEN ir.time_period = 0 THEN 'night_0_7'
                    WHEN ir.time_period = 1 THEN 'morning_rush_8_9'
                    WHEN ir.time_period = 2 THEN 'lunch_rush_10_11'
                    WHEN ir.time_period = 3 THEN 'afternoon_12_16'
                    WHEN ir.time_period = 4 THEN 'evening_rush_17_19'
                    WHEN ir.time_period = 5 THEN 'night_20_23'
                    ELSE 'unknown'
                END,
                MONTH(ir.admission_date)
        ) t
        ORDER BY 
            CASE time_period
                WHEN 'night_0_7' THEN 1
                WHEN 'morning_rush_8_9' THEN 2
                WHEN 'lunch_rush_10_11' THEN 3
                WHEN 'afternoon_12_16' THEN 4
                WHEN 'evening_rush_17_19' THEN 5
                WHEN 'night_20_23' THEN 6
                WHEN 'total' THEN 7
                ELSE 8
            END,
            month
    </select>

    <!-- 获取创伤部位分析数据 -->
    <select id="getInjuryAnalysisData" resultType="java.util.Map">
        SELECT 
            ir.injury_location as injury_site,
            COUNT(*) as patient_count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM InjuryRecord WHERE admission_date BETWEEN #{startDate} AND #{endDate}), 2) as percentage
        FROM InjuryRecord ir
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND ir.injury_location IS NOT NULL AND ir.injury_location != ''
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        GROUP BY ir.injury_location
        ORDER BY COUNT(*) DESC
        LIMIT 10
    </select>

    <!-- 获取ISS评分分布数据 -->
    <select id="getISSScoreDistributionData" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN '0分'
                WHEN iss.iss_score BETWEEN 1 AND 8 THEN '1-8分'
                WHEN iss.iss_score BETWEEN 9 AND 15 THEN '9-15分'
                WHEN iss.iss_score BETWEEN 16 AND 24 THEN '16-24分'
                WHEN iss.iss_score &gt;= 25 THEN '25分以上'
                ELSE '未知'
            END as score_range,
            COUNT(*) as patient_count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM InjuryRecord WHERE admission_date BETWEEN #{startDate} AND #{endDate}), 2) as percentage
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        GROUP BY 
            CASE 
                WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN '0分'
                WHEN iss.iss_score BETWEEN 1 AND 8 THEN '1-8分'
                WHEN iss.iss_score BETWEEN 9 AND 15 THEN '9-15分'
                WHEN iss.iss_score BETWEEN 16 AND 24 THEN '16-24分'
                WHEN iss.iss_score &gt;= 25 THEN '25分以上'
                ELSE '未知'
            END
        ORDER BY COUNT(*) DESC
    </select>

    <!-- 获取身体区域损伤数据 -->
    <select id="getBodyRegionInjuryData" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN iss.head_neck IS NOT NULL AND iss.head_neck != '' THEN '头颈部'
                WHEN iss.face IS NOT NULL AND iss.face != '' THEN '面部'
                WHEN iss.chest IS NOT NULL AND iss.chest != '' THEN '胸部'
                WHEN iss.abdomen IS NOT NULL AND iss.abdomen != '' THEN '腹部'
                WHEN iss.limbs IS NOT NULL AND iss.limbs != '' THEN '四肢'
                WHEN iss.body IS NOT NULL AND iss.body != '' THEN '体表'
                ELSE '未知'
            END as body_region,
            COUNT(*) as injury_count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM InjuryRecord WHERE admission_date BETWEEN #{startDate} AND #{endDate}), 2) as percentage
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        GROUP BY 
            CASE 
                WHEN iss.head_neck IS NOT NULL AND iss.head_neck != '' THEN '头颈部'
                WHEN iss.face IS NOT NULL AND iss.face != '' THEN '面部'
                WHEN iss.chest IS NOT NULL AND iss.chest != '' THEN '胸部'
                WHEN iss.abdomen IS NOT NULL AND iss.abdomen != '' THEN '腹部'
                WHEN iss.limbs IS NOT NULL AND iss.limbs != '' THEN '四肢'
                WHEN iss.body IS NOT NULL AND iss.body != '' THEN '体表'
                ELSE '未知'
            END
        ORDER BY COUNT(*) DESC
    </select>

    <!-- 获取身体区域损伤旭日图数据 -->
    <select id="getBodyRegionSunburstData" resultType="java.util.Map">
        SELECT 
            'head_neck' as body_region,
            iss.head_neck as severity_level,
            COUNT(*) as injury_count
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND iss.head_neck IS NOT NULL AND iss.head_neck != '' AND iss.head_neck != '0'
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        GROUP BY iss.head_neck
        
        UNION ALL
        
        SELECT 
            'face' as body_region,
            iss.face as severity_level,
            COUNT(*) as injury_count
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND iss.face IS NOT NULL AND iss.face != '' AND iss.face != '0'
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        GROUP BY iss.face
        
        UNION ALL
        
        SELECT 
            'chest' as body_region,
            iss.chest as severity_level,
            COUNT(*) as injury_count
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND iss.chest IS NOT NULL AND iss.chest != '' AND iss.chest != '0'
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        GROUP BY iss.chest
        
        UNION ALL
        
        SELECT 
            'abdomen' as body_region,
            iss.abdomen as severity_level,
            COUNT(*) as injury_count
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND iss.abdomen IS NOT NULL AND iss.abdomen != '' AND iss.abdomen != '0'
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        GROUP BY iss.abdomen
        
        UNION ALL
        
        SELECT 
            'limbs' as body_region,
            iss.limbs as severity_level,
            COUNT(*) as injury_count
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND iss.limbs IS NOT NULL AND iss.limbs != '' AND iss.limbs != '0'
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        GROUP BY iss.limbs
        
        UNION ALL
        
        SELECT 
            'body' as body_region,
            iss.body as severity_level,
            COUNT(*) as injury_count
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND iss.body IS NOT NULL AND iss.body != '' AND iss.body != '0'
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        GROUP BY iss.body
        
        ORDER BY body_region, severity_level
    </select>

    <!-- 获取干预时间效率数据 -->
    <select id="getInterventionTimeEfficiencyData" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) IS NULL THEN '无数据'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 30 THEN '30分钟以内'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 60 THEN '31-60分钟'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 120 THEN '61-120分钟'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 240 THEN '121-240分钟'
                ELSE '240分钟以上'
            END as time_range,
            COUNT(*) as patient_count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM InjuryRecord WHERE admission_date BETWEEN #{startDate} AND #{endDate}), 2) as percentage
        FROM InjuryRecord ir
        INNER JOIN interventiontime it ON ir.patient_id = it.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        GROUP BY 
            CASE 
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) IS NULL THEN '无数据'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 30 THEN '30分钟以内'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 60 THEN '31-60分钟'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 120 THEN '61-120分钟'
                WHEN TIMESTAMPDIFF(MINUTE, 
                    STR_TO_DATE(CONCAT(ir.admission_date, ' ', ir.admission_time), '%Y-%m-%d %H%i'), 
                    STR_TO_DATE(CONCAT(it.leave_surgery_date, ' ', it.leave_surgery_time), '%Y-%m-%d %H%i')) &lt;= 240 THEN '121-240分钟'
                ELSE '240分钟以上'
            END
        ORDER BY COUNT(*) DESC
    </select>

    <!-- 获取患者流向数据 -->
    <select id="getPatientFlowData" resultType="java.util.Map">
        SELECT 
            it.patient_destination as destination,
            COUNT(*) as patient_count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM InjuryRecord WHERE admission_date BETWEEN #{startDate} AND #{endDate}), 2) as percentage
        FROM InjuryRecord ir
        INNER JOIN interventiontime it ON ir.patient_id = it.patient_id
        WHERE ir.admission_date BETWEEN #{startDate} AND #{endDate}
        AND it.patient_destination IS NOT NULL AND it.patient_destination != ''
        GROUP BY it.patient_destination
        ORDER BY COUNT(*) DESC
        LIMIT 10
    </select>

    <!-- 获取伤因分布数据 - 12个月x5种伤因 -->
    <select id="getInjuryCauseDistributionData" resultType="java.util.Map">
        SELECT 
            MONTH(ir.admission_date) as month,
            ir.injury_cause_category,
            COUNT(*) as patient_count
        FROM InjuryRecord ir
        WHERE 1=1
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        <if test="startDate != null and endDate != null">
            AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
        </if>
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        AND ir.injury_cause_category IS NOT NULL
        GROUP BY MONTH(ir.admission_date), ir.injury_cause_category
        ORDER BY MONTH(ir.admission_date), ir.injury_cause_category
    </select>

    <!-- 获取ISS分布数据（轻伤、重伤、严重伤） -->
    <select id="getISSDistributionData" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 'light'
                WHEN iss.iss_score BETWEEN 1 AND 16 THEN 'light'
                WHEN iss.iss_score BETWEEN 17 AND 25 THEN 'severe'
                WHEN iss.iss_score > 25 THEN 'critical'
                ELSE 'light'
            END as severity_level,
            COUNT(*) as patient_count
        FROM InjuryRecord ir
        INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
        WHERE 1=1
        <if test="startDate != null and endDate != null">
            AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
        </if>
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
        GROUP BY 
            CASE 
                WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 'light'
                WHEN iss.iss_score BETWEEN 1 AND 16 THEN 'light'
                WHEN iss.iss_score BETWEEN 17 AND 25 THEN 'severe'
                WHEN iss.iss_score > 25 THEN 'critical'
                ELSE 'light'
            END
        ORDER BY 
            CASE 
                WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 'light'
                WHEN iss.iss_score BETWEEN 1 AND 16 THEN 'light'
                WHEN iss.iss_score BETWEEN 17 AND 25 THEN 'severe'
                WHEN iss.iss_score > 25 THEN 'critical'
                ELSE 'light'
            END
    </select>

    <!-- 获取GCS分布数据 -->
    <select id="getGCSDistributionData" resultType="java.util.Map">
        SELECT 
            level,
            count
        FROM (
            SELECT 
                CASE 
                    WHEN gcs.total_score = 15 THEN '15'
                    WHEN gcs.total_score BETWEEN 12 AND 14 THEN '12-14'
                    WHEN gcs.total_score BETWEEN 9 AND 11 THEN '9-11'
                    WHEN gcs.total_score BETWEEN 3 AND 8 THEN '3-8'
                    ELSE 'unknown'
                END as level,
                COUNT(*) as count
            FROM gcs_score gcs
            INNER JOIN patient p ON gcs.patient_id = p.patient_id
            INNER JOIN interventiontime i ON p.patient_id = i.patient_id
            INNER JOIN injuryrecord ir ON p.patient_id = ir.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            AND gcs.total_score IS NOT NULL
            GROUP BY 
                CASE 
                    WHEN gcs.total_score = 15 THEN '15'
                    WHEN gcs.total_score BETWEEN 12 AND 14 THEN '12-14'
                    WHEN gcs.total_score BETWEEN 9 AND 11 THEN '9-11'
                    WHEN gcs.total_score BETWEEN 3 AND 8 THEN '3-8'
                    ELSE 'unknown'
                END
        ) t
        ORDER BY 
            CASE level
                WHEN '15' THEN 1
                WHEN '12-14' THEN 2
                WHEN '9-11' THEN 3
                WHEN '3-8' THEN 4
                ELSE 5
            END
    </select>

    <!-- 获取RTS分布数据 -->
    <select id="getRTSDistributionData" resultType="java.util.Map">
        SELECT 
            CAST(total_score AS CHAR) as score,
            COUNT(*) as count
        FROM (
            SELECT 
                (rts.gcs_score + rts.sbp_score + rts.rr_score) as total_score
            FROM rts_score rts
            INNER JOIN patient p ON rts.patient_id = p.patient_id
            INNER JOIN interventiontime i ON p.patient_id = i.patient_id
            INNER JOIN injuryrecord ir ON p.patient_id = ir.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            AND rts.gcs_score IS NOT NULL 
            AND rts.sbp_score IS NOT NULL 
            AND rts.rr_score IS NOT NULL
        ) t
        GROUP BY total_score
        ORDER BY total_score DESC
    </select>

    <!-- 获取人群身体热力图数据 -->
    <select id="getPopulationBodyHeatmapData" resultType="java.util.Map">
        SELECT 
            body_part,
            AVG(severity_value) as average_severity,
            COUNT(DISTINCT patient_id) as patient_count
        FROM (
            SELECT 
                'head_neck' as body_part,
                ir.patient_id,
                CASE 
                    WHEN iss.head_neck LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.head_neck, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.head_neck AS DECIMAL(3,1))
                END as severity_value
            FROM InjuryRecord ir
            INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            <if test="ageGroup != null">
                AND ir.age_group = #{ageGroup}
            </if>
            <if test="gender != null">
                AND ir.gender = #{gender}
            </if>
            <if test="severity != null">
                AND CASE 
                    WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 0
                    WHEN iss.iss_score BETWEEN 1 AND 16 THEN 1
                    WHEN iss.iss_score BETWEEN 17 AND 25 THEN 2
                    WHEN iss.iss_score > 25 THEN 2
                    ELSE 0
                END = #{severity}
            </if>
            AND iss.head_neck IS NOT NULL 
            AND iss.head_neck != '0' 
            AND iss.head_neck != ''
            AND (
                CASE 
                    WHEN iss.head_neck LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.head_neck, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.head_neck AS DECIMAL(3,1))
                END
            ) > 0
            
            UNION ALL
            
            SELECT 
                'face' as body_part,
                ir.patient_id,
                CASE 
                    WHEN iss.face LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.face, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.face AS DECIMAL(3,1))
                END as severity_value
            FROM InjuryRecord ir
            INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            <if test="ageGroup != null">
                AND ir.age_group = #{ageGroup}
            </if>
            <if test="gender != null">
                AND ir.gender = #{gender}
            </if>
            <if test="severity != null">
                AND CASE 
                    WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 0
                    WHEN iss.iss_score BETWEEN 1 AND 16 THEN 1
                    WHEN iss.iss_score BETWEEN 17 AND 25 THEN 2
                    WHEN iss.iss_score > 25 THEN 2
                    ELSE 0
                END = #{severity}
            </if>
            AND iss.face IS NOT NULL 
            AND iss.face != '0' 
            AND iss.face != ''
            AND (
                CASE 
                    WHEN iss.face LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.face, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.face AS DECIMAL(3,1))
                END
            ) > 0
            
            UNION ALL
            
            SELECT 
                'chest' as body_part,
                ir.patient_id,
                CASE 
                    WHEN iss.chest LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.chest, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.chest AS DECIMAL(3,1))
                END as severity_value
            FROM InjuryRecord ir
            INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            <if test="ageGroup != null">
                AND ir.age_group = #{ageGroup}
            </if>
            <if test="gender != null">
                AND ir.gender = #{gender}
            </if>
            <if test="severity != null">
                AND CASE 
                    WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 0
                    WHEN iss.iss_score BETWEEN 1 AND 16 THEN 1
                    WHEN iss.iss_score BETWEEN 17 AND 25 THEN 2
                    WHEN iss.iss_score > 25 THEN 2
                    ELSE 0
                END = #{severity}
            </if>
            AND iss.chest IS NOT NULL 
            AND iss.chest != '0' 
            AND iss.chest != ''
            AND (
                CASE 
                    WHEN iss.chest LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.chest, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.chest AS DECIMAL(3,1))
                END
            ) > 0
            
            UNION ALL
            
            SELECT 
                'abdomen' as body_part,
                ir.patient_id,
                CASE 
                    WHEN iss.abdomen LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.abdomen, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.abdomen AS DECIMAL(3,1))
                END as severity_value
            FROM InjuryRecord ir
            INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            <if test="ageGroup != null">
                AND ir.age_group = #{ageGroup}
            </if>
            <if test="gender != null">
                AND ir.gender = #{gender}
            </if>
            <if test="severity != null">
                AND CASE 
                    WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 0
                    WHEN iss.iss_score BETWEEN 1 AND 16 THEN 1
                    WHEN iss.iss_score BETWEEN 17 AND 25 THEN 2
                    WHEN iss.iss_score > 25 THEN 2
                    ELSE 0
                END = #{severity}
            </if>
            AND iss.abdomen IS NOT NULL 
            AND iss.abdomen != '0' 
            AND iss.abdomen != ''
            AND (
                CASE 
                    WHEN iss.abdomen LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.abdomen, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.abdomen AS DECIMAL(3,1))
                END
            ) > 0
            
            UNION ALL
            
            SELECT 
                'limbs' as body_part,
                ir.patient_id,
                CASE 
                    WHEN iss.limbs LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.limbs, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.limbs AS DECIMAL(3,1))
                END as severity_value
            FROM InjuryRecord ir
            INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            <if test="ageGroup != null">
                AND ir.age_group = #{ageGroup}
            </if>
            <if test="gender != null">
                AND ir.gender = #{gender}
            </if>
            <if test="severity != null">
                AND CASE 
                    WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 0
                    WHEN iss.iss_score BETWEEN 1 AND 16 THEN 1
                    WHEN iss.iss_score BETWEEN 17 AND 25 THEN 2
                    WHEN iss.iss_score > 25 THEN 2
                    ELSE 0
                END = #{severity}
            </if>
            AND iss.limbs IS NOT NULL 
            AND iss.limbs != '0' 
            AND iss.limbs != ''
            AND (
                CASE 
                    WHEN iss.limbs LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.limbs, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.limbs AS DECIMAL(3,1))
                END
            ) > 0
            
            UNION ALL
            
            SELECT 
                'body' as body_part,
                ir.patient_id,
                CASE 
                    WHEN iss.body LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.body, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.body AS DECIMAL(3,1))
                END as severity_value
            FROM InjuryRecord ir
            INNER JOIN iss_patient_injury_severity iss ON ir.patient_id = iss.patient_id
            WHERE 1=1
            <if test="startDate != null and endDate != null">
                AND ir.admission_date BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="year != null">
                AND YEAR(ir.admission_date) = #{year}
            </if>
            <if test="season != null">
                AND ir.season = #{season}
            </if>
            <if test="timePeriod != null">
                AND ir.time_period = #{timePeriod}
            </if>
            <if test="ageGroup != null">
                AND ir.age_group = #{ageGroup}
            </if>
            <if test="gender != null">
                AND ir.gender = #{gender}
            </if>
            <if test="severity != null">
                AND CASE 
                    WHEN iss.iss_score IS NULL OR iss.iss_score = 0 THEN 0
                    WHEN iss.iss_score BETWEEN 1 AND 16 THEN 1
                    WHEN iss.iss_score BETWEEN 17 AND 25 THEN 2
                    WHEN iss.iss_score > 25 THEN 2
                    ELSE 0
                END = #{severity}
            </if>
            AND iss.body IS NOT NULL 
            AND iss.body != '0' 
            AND iss.body != ''
            AND (
                CASE 
                    WHEN iss.body LIKE '%|%' THEN 
                        CAST(SUBSTRING_INDEX(iss.body, '|', -1) AS DECIMAL(3,1))
                    ELSE 
                        CAST(iss.body AS DECIMAL(3,1))
                END
            ) > 0
        ) body_parts_data
        GROUP BY body_part
        ORDER BY body_part
    </select>

    <!-- 获取总患者数量 - 支持四个维度筛选 -->
    <select id="getTotalPatients" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT p.patient_id) 
        FROM patient p 
        INNER JOIN interventiontime i ON p.patient_id = i.patient_id
        INNER JOIN injuryrecord ir ON p.patient_id = ir.patient_id
        WHERE i.admission_date BETWEEN #{startDate} AND #{endDate}
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
    </select>

    <!-- 获取平均干预时间（分钟） - 支持四个维度筛选 -->
    <select id="getAverageInterventionTime" resultType="java.lang.Double">
        SELECT AVG(TIMESTAMPDIFF(MINUTE, 
            STR_TO_DATE(CONCAT(i.admission_date, ' ', i.admission_time), '%Y-%m-%d %H%i'), 
            STR_TO_DATE(CONCAT(i.leave_surgery_date, ' ', i.leave_surgery_time), '%Y-%m-%d %H%i'))) 
        FROM interventiontime i 
        INNER JOIN injuryrecord ir ON i.patient_id = ir.patient_id
        WHERE i.admission_date BETWEEN #{startDate} AND #{endDate} 
        AND i.leave_surgery_date IS NOT NULL AND i.leave_surgery_time IS NOT NULL
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
    </select>

    <!-- 获取救治成功率（百分比） - 支持四个维度筛选 -->
    <select id="getSuccessRate" resultType="java.lang.Double">
        SELECT 
            CASE 
                WHEN COUNT(*) = 0 THEN 0 
                ELSE (COUNT(CASE WHEN i.death = '否' OR i.death IS NULL THEN 1 END) * 100.0 / COUNT(*)) 
            END 
        FROM interventiontime i 
        INNER JOIN injuryrecord ir ON i.patient_id = ir.patient_id
        WHERE i.admission_date BETWEEN #{startDate} AND #{endDate}
        <if test="year != null">
            AND YEAR(ir.admission_date) = #{year}
        </if>
        <if test="season != null">
            AND ir.season = #{season}
        </if>
        <if test="timePeriod != null">
            AND ir.time_period = #{timePeriod}
        </if>
    </select>

</mapper>
