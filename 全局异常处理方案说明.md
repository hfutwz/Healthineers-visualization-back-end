# å…¨å±€å¼‚å¸¸å¤„ç†æ–¹æ¡ˆè¯´æ˜

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–¹æ¡ˆä¸ºç³»ç»Ÿæä¾›äº†å®Œå–„çš„å…¨å±€å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æ‰€æœ‰å¼‚å¸¸éƒ½èƒ½è¢«ç»Ÿä¸€æ•è·å¹¶è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œé¿å…ç³»ç»Ÿå´©æºƒã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼šæ‰€æœ‰å¼‚å¸¸ç»Ÿä¸€å¤„ç†ï¼Œè¿”å›ä¸€è‡´çš„å“åº”æ ¼å¼
2. **å‹å¥½é”™è¯¯ä¿¡æ¯**ï¼šå°†æŠ€æœ¯å¼‚å¸¸è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
3. **é”™è¯¯ç ç®¡ç†**ï¼šé€šè¿‡é”™è¯¯ç æšä¸¾ç»Ÿä¸€ç®¡ç†é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯
4. **æ—¥å¿—è®°å½•**ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
5. **å‘åå…¼å®¹**ï¼šä¿æŒä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§

## ğŸ“ æ–‡ä»¶ç»“æ„

```
com.demo
â”œâ”€â”€ exception/
â”‚   â”œâ”€â”€ BusinessException.java      # è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ç±»
â”‚   â”œâ”€â”€ ErrorCode.java              # é”™è¯¯ç æšä¸¾ç±»
â”‚   â””â”€â”€ ExceptionUtils.java         # å¼‚å¸¸å¤„ç†å·¥å…·ç±»
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ GlobalExceptionHandler.java # å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ WebExceptionAdvice.java     # æ—§å¼‚å¸¸å¤„ç†å™¨ï¼ˆå·²åºŸå¼ƒï¼‰
â””â”€â”€ dto/
    â””â”€â”€ Result.java                 # ç»Ÿä¸€å“åº”ç»“æœç±»ï¼ˆå·²å¢å¼ºï¼‰
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. BusinessExceptionï¼ˆè‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ï¼‰

ç”¨äºå¤„ç†ä¸šåŠ¡é€»è¾‘ä¸­çš„å¼‚å¸¸æƒ…å†µã€‚

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```java
// æ–¹å¼1ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸
throw new BusinessException("æ‚£è€…ä¸å­˜åœ¨");

// æ–¹å¼2ï¼šä½¿ç”¨é”™è¯¯ç 
throw new BusinessException(ErrorCode.PATIENT_NOT_FOUND);

// æ–¹å¼3ï¼šä½¿ç”¨é”™è¯¯ç å’Œè‡ªå®šä¹‰æ¶ˆæ¯
throw new BusinessException(ErrorCode.PATIENT_NOT_FOUND, "æ‚£è€…ID: " + patientId + " ä¸å­˜åœ¨");
```

### 2. ErrorCodeï¼ˆé”™è¯¯ç æšä¸¾ï¼‰

å®šä¹‰äº†ç³»ç»Ÿä¸­æ‰€æœ‰å¸¸è§çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ã€‚

**é”™è¯¯ç åˆ†ç±»ï¼š**
- `1000-1999`ï¼šé€šç”¨é”™è¯¯ç ï¼ˆå‚æ•°é”™è¯¯ã€æ“ä½œå¤±è´¥ç­‰ï¼‰
- `2000-2999`ï¼šä¸šåŠ¡é”™è¯¯ç ï¼ˆæ‚£è€…ä¸å­˜åœ¨ã€æ•°æ®ä¸å­˜åœ¨ç­‰ï¼‰
- `3000-3999`ï¼šæ–‡ä»¶æ“ä½œé”™è¯¯ç ï¼ˆæ–‡ä»¶ä¸Šä¼ å¤±è´¥ã€Excelå¯¼å…¥å¤±è´¥ç­‰ï¼‰
- `4000-4999`ï¼šæ•°æ®åº“æ“ä½œé”™è¯¯ç ï¼ˆæ•°æ®åº“è¿æ¥å¤±è´¥ã€SQLæ‰§è¡Œå¤±è´¥ç­‰ï¼‰
- `5000-5999`ï¼šç³»ç»Ÿé”™è¯¯ç ï¼ˆç³»ç»Ÿå†…éƒ¨é”™è¯¯ã€æœåŠ¡ä¸å¯ç”¨ç­‰ï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```java
// è¿”å›é”™è¯¯å“åº”
return Result.error(ErrorCode.PATIENT_NOT_FOUND);

// è¿”å›é”™è¯¯å“åº”ï¼ˆè‡ªå®šä¹‰æ¶ˆæ¯ï¼‰
return Result.error(ErrorCode.PATIENT_NOT_FOUND, "æ‚£è€…ID: " + patientId + " ä¸å­˜åœ¨");
```

### 3. GlobalExceptionHandlerï¼ˆå…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼‰

ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¼‚å¸¸ï¼ŒåŒ…æ‹¬ï¼š

- âœ… **ä¸šåŠ¡å¼‚å¸¸**ï¼š`BusinessException`
- âœ… **å‚æ•°æ ¡éªŒå¼‚å¸¸**ï¼š`MethodArgumentNotValidException`ã€`BindException`
- âœ… **å‚æ•°ç¼ºå¤±å¼‚å¸¸**ï¼š`MissingServletRequestParameterException`
- âœ… **HTTPæ¶ˆæ¯å¼‚å¸¸**ï¼š`HttpMessageNotReadableException`
- âœ… **æ–‡ä»¶ä¸Šä¼ å¼‚å¸¸**ï¼š`MaxUploadSizeExceededException`ã€`MultipartException`
- âœ… **æ•°æ®åº“å¼‚å¸¸**ï¼š`SQLException`ã€`DataAccessException`ã€`DataIntegrityViolationException`
- âœ… **ç³»ç»Ÿå¼‚å¸¸**ï¼š`NullPointerException`ã€`ClassCastException`ã€`IllegalArgumentException`
- âœ… **å…¶ä»–å¼‚å¸¸**ï¼š`RuntimeException`ã€`Exception`ï¼ˆå…œåº•å¤„ç†ï¼‰

### 4. ExceptionUtilsï¼ˆå¼‚å¸¸å¤„ç†å·¥å…·ç±»ï¼‰

æä¾›ä¾¿æ·çš„å¼‚å¸¸æŠ›å‡ºæ–¹æ³•ã€‚

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```java
// æ¡ä»¶åˆ¤æ–­
ExceptionUtils.requireTrue(patient != null, ErrorCode.PATIENT_NOT_FOUND);

// éç©ºåˆ¤æ–­
ExceptionUtils.requireNotNull(patientId, "æ‚£è€…IDä¸èƒ½ä¸ºç©º");

// å­—ç¬¦ä¸²éç©ºåˆ¤æ–­
ExceptionUtils.requireNotBlank(name, "æ‚£è€…å§“åä¸èƒ½ä¸ºç©º");
```

### 5. Resultï¼ˆç»Ÿä¸€å“åº”ç»“æœç±»ï¼‰

å·²å¢å¼ºï¼Œæ–°å¢ `code` å­—æ®µç”¨äºé”™è¯¯ç ã€‚

**å“åº”æ ¼å¼ï¼š**
```json
{
  "success": true/false,
  "errorMsg": "é”™è¯¯ä¿¡æ¯",
  "code": 200,
  "data": {},
  "total": 0
}
```

## ğŸ“ ä½¿ç”¨æŒ‡å—

### åœ¨Controllerä¸­ä½¿ç”¨

#### æ–¹å¼1ï¼šç›´æ¥è¿”å›Resultï¼ˆæ¨èï¼‰
```java
@GetMapping("/{patientId}")
public Result getPatient(@PathVariable Integer patientId) {
    Patient patient = patientService.getById(patientId);
    if (patient == null) {
        return Result.error(ErrorCode.PATIENT_NOT_FOUND);
    }
    return Result.ok(patient);
}
```

#### æ–¹å¼2ï¼šæŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼ˆæ¨èï¼‰
```java
@GetMapping("/{patientId}")
public Result getPatient(@PathVariable Integer patientId) {
    Patient patient = patientService.getById(patientId);
    if (patient == null) {
        throw new BusinessException(ErrorCode.PATIENT_NOT_FOUND);
    }
    return Result.ok(patient);
}
```

#### æ–¹å¼3ï¼šä½¿ç”¨å·¥å…·ç±»
```java
@GetMapping("/{patientId}")
public Result getPatient(@PathVariable Integer patientId) {
    Patient patient = patientService.getById(patientId);
    ExceptionUtils.requireNotNull(patient, ErrorCode.PATIENT_NOT_FOUND);
    return Result.ok(patient);
}
```

### åœ¨Serviceä¸­ä½¿ç”¨

```java
public Patient getPatientById(Integer patientId) {
    if (patientId == null || patientId <= 0) {
        throw new BusinessException(ErrorCode.PATIENT_ID_INVALID);
    }
    
    Patient patient = patientMapper.selectById(patientId);
    if (patient == null) {
        throw new BusinessException(ErrorCode.PATIENT_NOT_FOUND);
    }
    
    return patient;
}
```

### å‚æ•°æ ¡éªŒ

ä½¿ç”¨ `@Valid` æ³¨è§£è¿›è¡Œå‚æ•°æ ¡éªŒï¼š

```java
@PostMapping("/create")
public Result createPatient(@Valid @RequestBody PatientDTO patientDTO) {
    // å¦‚æœå‚æ•°æ ¡éªŒå¤±è´¥ï¼Œä¼šè‡ªåŠ¨æŠ›å‡º MethodArgumentNotValidException
    // å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¼šè‡ªåŠ¨å¤„ç†å¹¶è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    patientService.save(patientDTO);
    return Result.ok();
}
```

## ğŸ” å¼‚å¸¸å¤„ç†æµç¨‹

```
1. Controller/Service æŠ›å‡ºå¼‚å¸¸
   â†“
2. GlobalExceptionHandler æ•è·å¼‚å¸¸
   â†“
3. æ ¹æ®å¼‚å¸¸ç±»å‹é€‰æ‹©å¯¹åº”çš„å¤„ç†æ–¹æ³•
   â†“
4. è®°å½•æ—¥å¿—ï¼ˆlog.error/log.warnï¼‰
   â†“
5. è½¬æ¢ä¸ºç»Ÿä¸€çš„ Result å“åº”
   â†“
6. è¿”å›ç»™å‰ç«¯
```

## ğŸ“Š å¼‚å¸¸å¤„ç†ä¼˜å…ˆçº§

å¼‚å¸¸å¤„ç†æŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§åŒ¹é…ï¼š

1. **å…·ä½“å¼‚å¸¸**ï¼š`BusinessException`ã€`SQLException` ç­‰
2. **çˆ¶ç±»å¼‚å¸¸**ï¼š`DataAccessException`ã€`RuntimeException` ç­‰
3. **å…œåº•å¼‚å¸¸**ï¼š`Exception`ï¼ˆæ‰€æœ‰å¼‚å¸¸çš„çˆ¶ç±»ï¼‰

## ğŸ¨ å“åº”ç¤ºä¾‹

### æˆåŠŸå“åº”
```json
{
  "success": true,
  "errorMsg": null,
  "code": 200,
  "data": {
    "patientId": 1,
    "name": "å¼ ä¸‰"
  },
  "total": null
}
```

### ä¸šåŠ¡å¼‚å¸¸å“åº”
```json
{
  "success": false,
  "errorMsg": "æ‚£è€…ä¸å­˜åœ¨",
  "code": 2001,
  "data": null,
  "total": null
}
```

### å‚æ•°æ ¡éªŒå¤±è´¥å“åº”
```json
{
  "success": false,
  "errorMsg": "å‚æ•°æ ¡éªŒå¤±è´¥: æ‚£è€…å§“åä¸èƒ½ä¸ºç©º, å¹´é¾„å¿…é¡»å¤§äº0",
  "code": 1003,
  "data": null,
  "total": null
}
```

### æ•°æ®åº“å¼‚å¸¸å“åº”
```json
{
  "success": false,
  "errorMsg": "æ•°æ®é‡å¤ï¼Œè¿åå”¯ä¸€æ€§çº¦æŸ",
  "code": 4004,
  "data": null,
  "total": null
}
```

## âœ… ä¼˜åŠ¿

1. **ç»Ÿä¸€æ€§**ï¼šæ‰€æœ‰å¼‚å¸¸ç»Ÿä¸€å¤„ç†ï¼Œå“åº”æ ¼å¼ä¸€è‡´
2. **å‹å¥½æ€§**ï¼šæŠ€æœ¯å¼‚å¸¸è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
3. **å¯ç»´æŠ¤æ€§**ï¼šé”™è¯¯ç é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
4. **å¯è¿½æº¯æ€§**ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½è®°å½•è¯¦ç»†æ—¥å¿—
5. **å‘åå…¼å®¹**ï¼šä¿æŒä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§
6. **æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„å¼‚å¸¸ç±»å‹å’Œé”™è¯¯ç 

## ğŸš€ è¿ç§»å»ºè®®

### å¯¹äºç°æœ‰ä»£ç 

1. **ä¿ç•™ç°æœ‰try-catch**ï¼šå¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œä½†å»ºè®®é€æ­¥è¿ç§»
2. **é€æ­¥æ›¿æ¢**ï¼šå°† `Result.fail()` æ›¿æ¢ä¸ºæŠ›å‡º `BusinessException`
3. **ç»Ÿä¸€é”™è¯¯ç **ï¼šä½¿ç”¨ `ErrorCode` æšä¸¾æ›¿ä»£ç¡¬ç¼–ç çš„é”™è¯¯ä¿¡æ¯

### è¿ç§»ç¤ºä¾‹

**æ—§ä»£ç ï¼š**
```java
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (Exception e) {
    e.printStackTrace();
    return Result.fail("æ“ä½œå¤±è´¥ï¼š" + e.getMessage());
}
```

**æ–°ä»£ç ï¼š**
```java
// ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç”±å…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†
if (condition) {
    throw new BusinessException(ErrorCode.OPERATION_FAILED);
}
```

## ğŸ“š æ‰©å±•é”™è¯¯ç 

å¦‚éœ€æ·»åŠ æ–°çš„é”™è¯¯ç ï¼Œåœ¨ `ErrorCode` æšä¸¾ä¸­æ·»åŠ ï¼š

```java
// ä¸šåŠ¡é”™è¯¯ç  2000-2999
PATIENT_NOT_FOUND(2001, "æ‚£è€…ä¸å­˜åœ¨"),
YOUR_NEW_ERROR(2005, "ä½ çš„é”™è¯¯ä¿¡æ¯"),  // æ–°å¢
```

## ğŸ”’ æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ•è·æ‰€æœ‰å¼‚å¸¸**ï¼šè®©å…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚
2. **è®°å½•è¯¦ç»†æ—¥å¿—**ï¼šå¼‚å¸¸ä¿¡æ¯è¦è¯¦ç»†ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
3. **ä¸è¦æš´éœ²æ•æ„Ÿä¿¡æ¯**ï¼šç”Ÿäº§ç¯å¢ƒä¸è¦è¿”å›è¯¦ç»†çš„å †æ ˆä¿¡æ¯
4. **é”™è¯¯ç å”¯ä¸€æ€§**ï¼šç¡®ä¿é”™è¯¯ç ä¸é‡å¤
5. **HTTPçŠ¶æ€ç **ï¼šå¤§éƒ¨åˆ†å¼‚å¸¸è¿”å› `200 OK`ï¼Œåªæœ‰ç‰¹æ®Šå¼‚å¸¸è¿”å›å…¶ä»–çŠ¶æ€ç 

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- `GlobalExceptionHandler.java` - å¼‚å¸¸å¤„ç†é€»è¾‘
- `ErrorCode.java` - é”™è¯¯ç å®šä¹‰
- `BusinessException.java` - ä¸šåŠ¡å¼‚å¸¸ç±»

---

**ç‰ˆæœ¬ï¼š** v1.0  
**æ›´æ–°æ—¥æœŸï¼š** 2024-01-XX  
**ä½œè€…ï¼š** System

