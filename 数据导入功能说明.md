# 数据导入功能说明

## 功能概述

本功能实现了Excel数据导入前的验证机制，支持：
1. 上传Excel文件
2. 对每个数据表进行独立验证
3. 显示详细的验证错误信息（行号、患者ID、字段、错误原因）
4. 验证通过后执行数据导入

## 文件结构

### Python端
- `python_data/v3/patient_importer.py` - 患者数据导入器（已添加验证功能）
- `python_data/v3/validate_patient_data.py` - 数据验证脚本（返回JSON格式结果）

### Java后端
- `com.demo.upload.controller.DataImportController` - 数据导入控制器
- `com.demo.upload.service.PatientDataImportService` - 数据导入服务
- `com.demo.upload.dto.*` - 数据传输对象

### 前端
- `front-end/heatmap-project/src/views/DataImportPage.vue` - 数据导入页面

## 配置说明

### Python路径配置

在 `PatientDataImportService.java` 中需要配置以下路径：

```java
// Python脚本路径
private static final String PYTHON_SCRIPT_PATH = "F:/Healthineers-visualization/python_data/v3/validate_patient_data.py";

// Python可执行文件路径（需要根据实际环境修改）
private static final String PYTHON_PATH = "C:/Users/titk/AppData/Local/Programs/Python/Python310/python.exe";

// 导入脚本路径
private static final String IMPORT_SCRIPT_PATH = "F:/Healthineers-visualization/python_data/v3/main_importer.py";
```

**注意**：请根据实际环境修改这些路径。

## API接口

### 1. 验证患者数据
- **URL**: `/api/upload/validate/patient`
- **方法**: POST
- **参数**: `file` (MultipartFile)
- **返回**: 验证结果（包含错误列表）

### 2. 导入患者数据
- **URL**: `/api/upload/import/patient`
- **方法**: POST
- **参数**: `filePath` (String) - 已上传的文件路径
- **返回**: 导入结果

### 3. 验证并导入（一步完成）
- **URL**: `/api/upload/validate-and-import/patient`
- **方法**: POST
- **参数**: `file` (MultipartFile)
- **返回**: 验证结果和导入结果

## 使用流程

1. **访问数据导入页面**
   - 前端访问：http://localhost:8001/data-import
   - 或通过导航菜单点击"数据导入"

2. **上传Excel文件**
   - 点击上传区域选择Excel文件
   - 点击"上传文件"按钮

3. **验证数据**
   - 选择要验证的数据表
   - 点击"验证数据"按钮
   - 查看验证结果（如有错误会显示详细错误信息）

4. **导入数据**
   - 验证通过后，点击"导入数据"按钮
   - 查看导入结果

## 验证规则

### 患者基本信息表（Patient）

1. **患者ID（序号）**
   - 不能为空或0
   - 必须是有效的整数

2. **性别**
   - 可以为空
   - 如果有值，必须是：男、女、M、F、Male、Female

3. **年龄**
   - 范围：0-150

4. **身高**
   - 范围：30-250 cm（如果大于0）

5. **体重**
   - 范围：1-500 kg（如果大于0）

## 错误信息格式

验证错误信息包含以下字段：
- `row`: Excel行号（从1开始，包含标题行）
- `patientId`: 患者ID
- `field`: 字段名
- `value`: 错误的值
- `message`: 错误原因

## 扩展其他表的验证

要添加其他表的验证功能，需要：

1. **修改对应的导入器类**（如 `injury_record_importer.py`）
   - 添加 `validate_data()` 方法
   - 定义 `COLUMN_MAPPING` 常量

2. **创建验证脚本**（如 `validate_injury_record_data.py`）
   - 参考 `validate_patient_data.py`

3. **在Java后端添加对应的Service方法**
   - 参考 `PatientDataImportService.java`

4. **在Controller中添加对应的接口**
   - 参考 `DataImportController.java`

5. **在前端添加对应的表配置**
   - 在 `DataImportPage.vue` 的 `tables` 数组中添加

## 注意事项

1. Python环境必须安装以下依赖：
   - pandas
   - openpyxl（用于读取Excel）
   - pymysql（用于数据库操作）

2. 文件路径使用绝对路径，确保Java可以找到Python脚本

3. Excel文件列名必须与代码中定义的列名完全匹配（包括空格）

4. 验证失败时不会执行导入操作，需要先修复错误

5. 建议在生产环境中将Python路径配置到配置文件中，而不是硬编码

## 故障排查

### 问题1：Python脚本执行失败
- 检查Python路径是否正确
- 检查Python脚本路径是否存在
- 检查Python环境是否安装了所需依赖

### 问题2：验证结果为空
- 检查Excel文件列名是否匹配
- 检查Python脚本输出日志

### 问题3：导入失败
- 检查数据库连接配置
- 检查Excel数据格式
- 查看后端日志获取详细错误信息

